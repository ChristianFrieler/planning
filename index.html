<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🎸 Indie-Punk Event Manager</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Bebas+Neue&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>🎤 Indie-Punk Gigs</h1>
  </header>

  <main>
    <section id="event-form-section">
      <h2>Neues Event erstellen</h2>
      <form id="event-form">
        <input type="text" id="event-title" placeholder="Eventtitel" required />
        <input type="text" id="event-location" placeholder="Ort" required />
        <input type="date" id="event-date" required />
        <input type="number" id="event-tickets" placeholder="Anzahl Tickets" required />
        <button type="submit">Event hinzufügen</button>
      </form>
    </section>

    <section id="events-container">
      <h2>Geplante Events</h2>
      <div id="event-list"></div>
    </section>
  </main>

  <template id="event-template">
    <div class="event-card">
      <h3 class="event-title"></h3>
      <p class="event-meta"></p>
      <p class="event-tickets"></p>
      <button class="toggle-participants">Teilnehmer anzeigen</button>

      <div class="participants hidden">
        <ul class="participant-list"></ul>
        <input type="text" class="participant-name" placeholder="Neuer Teilnehmer" />
        <button class="add-participant">Hinzufügen</button>
      </div>
    </div>
  </template>

  <footer>
    <p>🎸 Powered by DIY Spirit • Indie Vibes only</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBUfRi-Y8t3G_jtj-G4i8IPD2Imwsovquk",
      authDomain: "ticketmaster-eb5b8.firebaseapp.com",
      projectId: "ticketmaster-eb5b8",
      storageBucket: "ticketmaster-eb5b8.firebasestorage.app",
      messagingSenderId: "158973544951",
      appId: "1:158973544951:web:4088e065dafc2c69d1c6f2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const form = document.getElementById('event-form');
    const eventList = document.getElementById('event-list');
    const template = document.getElementById('event-template');

    let events = [];

    const fetchEvents = async () => {
      const snapshot = await db.collection("events").get();
      events = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderEvents();
    };

    const saveEvent = async (event) => {
      await db.collection("events").add(event);
      fetchEvents();
    };

    const updateEventParticipants = async (id, updatedParticipants) => {
      await db.collection("events").doc(id).update({ participants: updatedParticipants });
      fetchEvents();
    };

    const renderEvents = () => {
      eventList.innerHTML = '';
      events.forEach(event => {
        // Fallback für alte Events ohne Teilnehmerfeld
        if (!event.participants) event.participants = [];
        const clone = template.content.cloneNode(true);
        clone.querySelector('.event-title').textContent = event.title;
        clone.querySelector('.event-meta').textContent = `${event.date} @ ${event.location}`;
        clone.querySelector('.event-tickets').textContent = `${event.participants.length} von ${event.tickets} Tickets vergeben`;

        const participantsEl = clone.querySelector('.participants');
        const toggleBtn = clone.querySelector('.toggle-participants');
        const listEl = clone.querySelector('.participant-list');
        const inputEl = clone.querySelector('.participant-name');
        const addBtn = clone.querySelector('.add-participant');

        toggleBtn.onclick = () => participantsEl.classList.toggle('hidden');

        const renderParticipants = () => {
          listEl.innerHTML = '';
          event.participants.forEach(name => {
            const li = document.createElement('li');
            li.textContent = name;
            listEl.appendChild(li);
          });
        };

        addBtn.onclick = () => {
          const name = inputEl.value.trim();
          if (!name || event.participants.length >= event.tickets) return;
          const updated = [...event.participants, name];
          updateEventParticipants(event.id, updated);
        };

        renderParticipants();
        eventList.appendChild(clone);
      });
    };

    form.onsubmit = e => {
      e.preventDefault();
      const newEvent = {
        title: form['event-title'].value,
        location: form['event-location'].value,
        date: form['event-date'].value,
        tickets: parseInt(form['event-tickets'].value),
        participants: []
      };
      saveEvent(newEvent);
      form.reset();
    };

    // On page load: load events
    fetchEvents();
  </script>
</body>
</html>
